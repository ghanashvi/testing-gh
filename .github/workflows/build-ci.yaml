steps:
  - name: Checkout CI Orchestration Repo
    uses: actions/checkout@v3

  - name: Clone Source Repository
    run: |
      REPO_NAME=$(echo "${{ github.event.client_payload.repository }}" | cut -d'/' -f2)
      git clone https://x-access-token:${{ secrets.CI_PAT }}@github.com/${{ github.event.client_payload.repository }}.git $REPO_NAME
      cd $REPO_NAME
      git checkout ${{ github.event.client_payload.sha }}

  - name: Authenticate to Google Cloud
    uses: google-github-actions/auth@v1
    with:
      workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
      service_account: 'github-actions-sa@axial-edition-463510-p5.iam.gserviceaccount.com'

  - name: Setup gcloud CLI
    uses: google-github-actions/setup-gcloud@v1

  - name: Configure Docker for Artifact Registry
    run: gcloud auth configure-docker us-central1-docker.pkg.dev

  - name: Detect Changed Services (TBD)
    run: |
      echo "TODO: Use git diff or file watcher to detect which services changed."
      echo "Example: SERVICES_CHANGED='service-a service-b'"
      # You can update this logic later with detection rules

  - name: Build and Push Image
    run: |
      REPO_NAME=$(echo "${{ github.event.client_payload.repository }}" | cut -d'/' -f2)
      COMMIT_TAG="${{ github.event.client_payload.sha }}"
      FEATURE_TAG=$(echo "${{ github.event.client_payload.ref }}" | sed 's|refs/heads/||')
      
      IMAGE_BASE="us-central1-docker.pkg.dev/axial-edition-463510-p5/quarantine-repo/$REPO_NAME"
      
      if [ -f "$REPO_NAME/Dockerfile" ]; then
        echo "Dockerfile found. Building image for $REPO_NAME..."
        cd $REPO_NAME
        
        docker build -t "$IMAGE_BASE:insecure-$COMMIT_TAG" \
                     -t "$IMAGE_BASE:insecure-$FEATURE_TAG" .
        
        docker push "$IMAGE_BASE:insecure-$COMMIT_TAG"
        docker push "$IMAGE_BASE:insecure-$FEATURE_TAG"
        
        echo "âœ… Image pushed to quarantine registry"
      else
        echo "âŒ Dockerfile not found, skipping build"
        exit 1
      fi

  - name: Trigger Security Scanning
    if: success()
    uses: peter-evans/repository-dispatch@v2
    with:
      token: ${{ secrets.CI_PAT }}
      repository: ${{ github.repository }}
      event-type: start-security-scanning
      client-payload: >-
        {
          "repository": "${{ github.event.client_payload.repository }}",
          "sha": "${{ github.event.client_payload.sha }}",
          "ref": "${{ github.event.client_payload.ref }}"
        }