################################################################################
# Workflow : Build ➜ On‑Demand Scan (fail on ANY vuln) ➜ Promote
################################################################################
name: Build ➜ Scan ➜ Promote

on:
  repository_dispatch:
    types: [app-code-change]

###############################################################################
# ------------------------------  Global ENV  ---------------------------------
###############################################################################
env:
  # Workload‑Identity Federation (OIDC)
  WORKLOAD_IDENTITY_PROVIDER: 'projects/906017862008/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
  SERVICE_ACCOUNT:            'ci-image-builder@axial-edition-463510-p5.iam.gserviceaccount.com'

  # Artifact Registry repos
  QUAR_IMAGE_REGISTRY:   us-central1-docker.pkg.dev/axial-edition-463510-p5/quarantine-repo
  SECURE_IMAGE_REGISTRY: us-central1-docker.pkg.dev/decent-creek-464109-p6/secure-repo
  GAR_LOCATION:          us-central1        # region for docker login
  ODS_LOCATION:          us                # region for On‑Demand Scan

  # Polling controls
  POLL_INTERVAL: 10      # seconds
  MAX_ATTEMPTS:  36      # 6 min

###############################################################################
# JOB 1 : Build & push changed Dockerfiles to *quarantine*
###############################################################################
jobs:
  build:
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }

    outputs:
      built_images: ${{ steps.collect.outputs.images_json }}
      repo_name:    ${{ steps.clone_repo.outputs.REPO_NAME }}
      commit_tag:   ${{ github.event.client_payload.sha }}

    steps:
    - uses: actions/checkout@v3           # orchestration repo

    - name: Clone Source Repository
      id: clone_repo
      run: |
        REPO_FULL="${{ github.event.client_payload.repository }}"
        REPO_NAME="${REPO_FULL#*/}"
        git clone https://x-access-token:${{ secrets.CI_PAT }}@github.com/$REPO_FULL "$REPO_NAME"
        cd "$REPO_NAME"
        git checkout "${{ github.event.client_payload.sha }}"
        echo "REPO_NAME=$REPO_NAME" >> "$GITHUB_OUTPUT"

    - id: base
      name: Resolve base SHA
      run: |
        cd "${{ steps.clone_repo.outputs.REPO_NAME }}"
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          echo "sha=$(git rev-parse HEAD~1)" >> "$GITHUB_OUTPUT"
        else
          echo "sha=4b825dc642cb6eb9a060e54bf8d69288fbee4904" >> "$GITHUB_OUTPUT"
        fi

    - id: diff
      name: Detect changed Dockerfiles
      uses: tj-actions/changed-files@v46
      with:
        token:     ${{ github.token }}
        path:      ${{ steps.clone_repo.outputs.REPO_NAME }}
        base_sha:  ${{ steps.base.outputs.sha }}
        sha:       ${{ github.event.client_payload.sha }}
        use_rest_api: false
        files: |
          **/Dockerfile*

    - uses: google-github-actions/auth@v1   # credentials file OK (checkout ran)
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account:            ${{ env.SERVICE_ACCOUNT }}

    - uses: docker/setup-buildx-action@v2
    - name: Configure Docker for GAR
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Build & Push images
      run: |
        set -e
        REPO="${{ steps.clone_repo.outputs.REPO_NAME }}"
        SHA="${{ github.event.client_payload.sha }}"
        cd "$REPO"
        : > /tmp/built.txt
        for FILE in ${{ steps.diff.outputs.all_changed_files }}; do
          [[ "$FILE" != *Dockerfile* ]] && continue
          DIR=$(dirname "$FILE")
          COMP=$(basename "$FILE" | sed -E 's/^Dockerfile[-\.]?//')
          COMP=${COMP:-default}
          TAG="$REPO-$COMP:insecure-$SHA"
          FULL="$QUAR_IMAGE_REGISTRY/$TAG"
          docker build -f "$FILE" -t "$FULL" "$DIR"
          docker push "$FULL"
          echo "$FULL" >> /tmp/built.txt
        done

    - id: collect
      name: Collect built images
      run: |
        if [ -s /tmp/built.txt ]; then
          jq -Rsc 'split("\n")[:-1]' /tmp/built.txt > /tmp/list.json
          echo "images_json=$(cat /tmp/list.json)" >> "$GITHUB_OUTPUT"
        else
          echo "images_json=[]" >> "$GITHUB_OUTPUT"
        fi

###############################################################################
# JOB 2 : On‑Demand Scan (fail on ANY vuln row)
###############################################################################
  ods_scan:
    needs: build
    if: needs.build.outputs.built_images != '[]'
    runs-on: ubuntu-latest
    permissions: { id-token: write }
    strategy:
      matrix:
        image: ${{ fromJson(needs.build.outputs.built_images) }}

    steps:
    # 1️⃣  tiny checkout so workspace exists
    - uses: actions/checkout@v3

    # 2️⃣  GCP auth (write credentials file for container mount)
    - uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account:            ${{ env.SERVICE_ACCOUNT }}

    # 3️⃣  Run scan inside Cloud‑SDK Docker image (has local‑extract component)
    - name: ODS scan & gate
      env:
        IMG:            ${{ matrix.image }}
        ODS_LOCATION:   ${{ env.ODS_LOCATION }}
        POLL_INTERVAL:  ${{ env.POLL_INTERVAL }}
        MAX_ATTEMPTS:   ${{ env.MAX_ATTEMPTS }}
      run: |
        set -e
        CREDS="$GOOGLE_APPLICATION_CREDENTIALS"
        docker run --rm \
          -v "$CREDS:/tmp/creds.json:ro" \
          -e GOOGLE_APPLICATION_CREDENTIALS=/tmp/creds.json \
          google/cloud-sdk:slim /bin/bash -c "
            set -e
            echo 'Scanning: $IMG'
            SCAN_ID=\$(gcloud artifacts docker images scan \"$IMG\" \
                        --location='$ODS_LOCATION' \
                        --format='value(response.scan)')
            echo \"Scan ID: \$SCAN_ID\"

            for i in \$(seq 1 $MAX_ATTEMPTS); do
              ROWS=\$(gcloud artifacts docker images list-vulnerabilities \$SCAN_ID \
                       --location='$ODS_LOCATION' \
                       --format='value(name)' | wc -l)
              if [ \"\$ROWS\" -gt 0 ]; then
                echo 'Vulnerabilities detected (rows='\"\$ROWS\"')'
                gcloud artifacts docker images list-vulnerabilities \$SCAN_ID \
                  --location='$ODS_LOCATION' \
                  --format='table(vulnerability.effectiveSeverity, vulnerability.shortDescription)'
                exit 1
              fi
              echo 'Waiting for results...'
              sleep $POLL_INTERVAL
            done

            echo 'Scan timed out or no vulnerabilities found.'
            exit 0
          "

###############################################################################
# JOB 3 : Promote (runs only if ods_scan passed = no vulnerabilities)
###############################################################################
  promote_secure:
    needs: [build, ods_scan]
    if: needs.ods_scan.result == 'success'
    runs-on: ubuntu-latest
    permissions: { id-token: write, packages: write }
    strategy:
      matrix:
        image: ${{ fromJson(needs.build.outputs.built_images) }}

    steps:
    # 1️⃣  GCP auth (no credentials file needed here)
    - uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
        service_account:            ${{ env.SERVICE_ACCOUNT }}
        create_credentials_file:    false

    # 2️⃣  Docker login to secure repo host
    - name: Configure Docker for GAR
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    # 3️⃣  Copy digest to secure repo / secure‑tag
    - id: copy
      name: Copy & tag secure
      run: |
        SRC="${{ matrix.image }}"
        DST=$(echo "$SRC" \
               | sed "s|$QUAR_IMAGE_REGISTRY|$SECURE_IMAGE_REGISTRY|" \
               | sed "s/:insecure-/:secure-/")
        gcloud artifacts docker images copy "$SRC" --destination="$DST" --quiet
        echo "dst=$DST" >> "$GITHUB_OUTPUT"

    # 4️⃣  Push digest/tag to GHCR
    - name: Push to GHCR
      env:
        COMMIT_TAG: ${{ needs.build.outputs.commit_tag }}
        DST:        ${{ steps.copy.outputs.dst }}
      run: |
        COMPONENT=$(basename "$DST" | cut -d':' -f1)
        GHCR="ghcr.io/${{ github.repository_owner }}/$COMPONENT:secure-$COMMIT_TAG"
        docker pull "$DST"
        echo "${{ github.token }}" | docker login ghcr.io -u ${GITHUB_ACTOR} --password-stdin
        docker tag "$DST" "$GHCR"
        docker push "$GHCR"
